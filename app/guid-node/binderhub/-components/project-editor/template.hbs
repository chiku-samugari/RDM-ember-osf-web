<div local-class='project_editor'>
    {{#if this.loading}}
        {{t 'binderhub.loading'}}
    {{else}}
        {{#if this.shouldResetConfigFiles}}
            {{t 'binderhub.deployment.unavailable'}}
            {{#if this.node.userHasWritePermission}}
                <button
                    data-test-view-dirty-fragile-files
                    type='button'
                    class='btn btn-default'
                    {{action this.viewDirtyFragileFiles target=this}}
                >
                    {{t 'binderhub.deployment.view_dirty_fragile_files'}}
                    {{this.dirtyFragileConfigurationFilenames}}
                </button>
                <button
                    data-test-reset-dirty-fragile-files
                    type='button'
                    class='btn btn-danger'
                    {{action (mut this.showDirtyFragileFileConfirmDialog) true}}
                >
                    {{t 'binderhub.deployment.reset_dirty_fragile_files'}}
                    {{this.dirtyFragileConfigurationFilenames}}
                </button>
            {{/if}}
        {{else}}
            <h3>{{t 'binderhub.deployment.environment'}}</h3>
            {{#if (or this.node.userHasWritePermission this.selectedImageUrl)}}
                {{#if this.imageSelecting}}
                    {{#each this.selectableImages.preferred as |image|}}
                        <GuidNode::Binderhub::-Components::ProjectEditor::BasicImageEntry
                            local-class='basic_image_entry'
                            @image={{image}}
                            @checked={{eq this.selectedImageUrl image.url}}
                            @isSelectionAllowed={{this.node.userHasWritePermission}}
                            @isSelecting={{true}}
                            @onButtonClick={{fn this.selectImage image.url}}
                        />
                    {{/each}}
                    <GuidNode::Binderhub::-Components::ProjectEditor::BasicImageEntry
                        local-class='basic_image_entry'
                        @image={{this.customImage}}
                        @checked={{eq this.selectedImageUrl this.customImage.url}}
                        @isSelectionAllowed={{this.node.userHasWritePermission}}
                        @isSelecting={{true}}
                        @onButtonClick={{fn this.selectCustomImage}}
                    />
                    <BsButton
                        local-class='deprecated_image_separator'
                        onClick={{action this.flipDeprecatedImages}}
                    >
                        {{#if this.showDeprecated}}
                            {{fa-icon 'chevron-down'}}
                        {{else}}
                            {{fa-icon 'chevron-right'}}
                        {{/if}}
                        {{t 'binderhub.deployment.deprecated_images_header'}}
                    </BsButton>
                    {{#if this.showDeprecated}}
                        {{#each this.selectableImages.deprecated as |image|}}
                            <GuidNode::Binderhub::-Components::ProjectEditor::BasicImageEntry
                                local-class='basic_image_entry'
                                @image={{image}}
                                @checked={{eq this.selectedImageUrl image.url}}
                                @isSelectionAllowed={{this.node.userHasWritePermission}}
                                @isSelecting={{true}}
                                @onButtonClick={{fn this.selectImage image.url}}
                            />
                        {{/each}}
                    {{/if}}
                {{else}}
                    <GuidNode::Binderhub::-Components::ProjectEditor::BasicImageEntry
                        local-class='basic_image_entry'
                        @image={{this.modifiedSelectedImage}}
                        @checked={{true}}
                        @isSelectionAllowed={{this.node.userHasWritePermission}}
                        @isSelecting={{false}}
                        @onButtonClick={{this.startBaseImageSelection}}
                    />
                {{/if}}
            {{else}}
                {{t 'binderhub.deployment.no_environment'}}
            {{/if}}
            {{#if this.isDockerfileEditorVisible}}
                <GuidNode::Binderhub::-Components::TextfileEditor
                    @title={{t 'binderhub.deployment.dockerfile_editor_title'}}
                    @content={{this.dockerfile}}
                    @enable={{not this.imageSelecting}}
                    @onSave={{this.saveDockerfile}}
                    @onChange={{this.editDockerfileContent}}
                    />
            {{/if}}
            {{#if this.isPackageEditorVisible}}
                <h3>{{t 'binderhub.deployment.additionalpackages'}}</h3>
                <div local-class='packages'>
                    <GuidNode::Binderhub::-Components::PackageEditor
                        data-test-package-editor='apt'
                        @node={{this.node}}
                        @label='apt-get'
                        @packages={{this.aptPackages}}
                        @onUpdate={{action this.aptUpdated}}
                        @editing={{if (eq this.editingPackage 'apt') 'editing'}}
                        @onEditingStart={{action (mut this.editingPackage) 'apt'}}
                        @onEditingEnd={{action (mut this.editingPackage) ''}}
                    />
                    {{#if this.condaSupported}}
                        <GuidNode::Binderhub::-Components::PackageEditor
                            data-test-package-editor='conda'
                            @node={{this.node}}
                            @label='conda'
                            @packages={{this.condaPackages}}
                            @onUpdate={{action this.condaUpdated}}
                            @editing={{if (eq this.editingPackage 'conda') 'editing'}}
                            @onEditingStart={{action (mut this.editingPackage) 'conda'}}
                            @onEditingEnd={{action (mut this.editingPackage) ''}}
                        />
                    {{/if}}
                    {{#if this.pipSupported}}
                        <GuidNode::Binderhub::-Components::PackageEditor
                            data-test-package-editor='pip'
                            @node={{this.node}}
                            @label='pip'
                            @packages={{this.pipPackages}}
                            @onUpdate={{action this.pipUpdated}}
                            @editing={{if (eq this.editingPackage 'pip') 'editing'}}
                            @onEditingStart={{action (mut this.editingPackage) 'pip'}}
                            @onEditingEnd={{action (mut this.editingPackage) ''}}
                        />
                    {{/if}}
                    {{#if this.rCranSupported}}
                        <GuidNode::Binderhub::-Components::PackageEditor
                            data-test-package-editor='rcran'
                            @node={{this.node}}
                            @label='R (CRAN)'
                            @packages={{this.rCranPackages}}
                            @onUpdate={{action this.rCranUpdated}}
                            @editing={{if (eq this.editingPackage 'rcran') 'editing'}}
                            @onEditingStart={{action (mut this.editingPackage) 'rcran'}}
                            @onEditingEnd={{action (mut this.editingPackage) ''}}
                        />
                    {{/if}}
                    {{#if this.rGitHubSupported}}
                        <GuidNode::Binderhub::-Components::PackageEditor
                            data-test-package-editor='rgithub'
                            @node={{this.node}}
                            @label='R (GitHub)'
                            @packages={{this.rGitHubPackages}}
                            @onUpdate={{action this.rGitHubUpdated}}
                            @editing={{if (eq this.editingPackage 'rgithub') 'editing'}}
                            @onEditingStart={{action (mut this.editingPackage) 'rgithub'}}
                            @onEditingEnd={{action (mut this.editingPackage) ''}}
                        />
                    {{/if}}
                    {{#if this.rMranSupported}}
                        <GuidNode::Binderhub::-Components::PackageEditor
                            data-test-package-editor='rmran'
                            @node={{this.node}}
                            @label='R (CRAN)'
                            @packages={{this.rMranPackages}}
                            @onUpdate={{action this.rMranUpdated}}
                            @editing={{if (eq this.editingPackage 'rmran') 'editing'}}
                            @onEditingStart={{action (mut this.editingPackage) 'rmran'}}
                            @onEditingEnd={{action (mut this.editingPackage) ''}}
                        />
                        {{#if this.mranVersionSettingError}}
                            <div local-class='environment_setting_error'>
                                {{t 'binderhub.deployment.mran_version_setting_error'}}
                            </div>
                        {{/if}}
                    {{/if}}
                    {{#if this.mpmSupported}}
                        <GuidNode::Binderhub::-Components::MpmPackageEditor
                            data-test-package-editor='mpm'
                            @node={{this.node}}
                            @label='MATLAB (mpm)'
                            @url={{t 'binderhub.deployment.info_urls.mpm'}}
                            @config={{this.mpmConfig}}
                            @onUpdate={{action this.mpmUpdated}}
                            @editing={{if (eq this.editingPackage 'mpm') 'editing'}}
                            @onEditingStart={{action (mut this.editingPackage) 'mpm'}}
                            @onEditingEnd={{action (mut this.editingPackage) ''}}
                        />
                    {{/if}}
                </div>
                <h3>
                    {{t 'binderhub.deployment.postinstallscript'}}
                    <OsfButton
                        @type='link'
                        @onClick={{action (mut this.postBuildOpen) (not this.postBuildOpen)}}
                    >
                        {{#if this.postBuildOpen}}
                            {{fa-icon 'chevron-down'}}
                        {{else}}
                            {{fa-icon 'chevron-right'}}
                        {{/if}}
                    </OsfButton>
                </h3>
                <div local-class='postscript_view'>
                    {{#if this.postBuildOpen}}
                        <textarea
                            data-test-post-build
                            readonly={{not this.node.userHasWritePermission}}
                            name='post_build'
                            class='form-control'
                            rows='4'
                            placeholder={{t 'binderhub.deployment.post_build_placeholder'}}
                            value={{this.postBuild}}
                            onkeyup={{action this.editPostBuild value='target.value'}}
                            onchange={{action this.editPostBuild value='target.value'}}
                        />

                        {{#if this.node.userHasWritePermission}}
                            <div local-class='postscript_button'>
                                <button
                                    data-test-save-post-build
                                    type='button'
                                    class='btn btn-default'
                                    disabled={{not this.editedPostBuild}}
                                    {{action this.savePostBuild}}
                                >
                                    {{fa-icon 'save'}}
                                    {{t 'binderhub.deployment.save_post_build'}}
                                </button>
                            </div>
                        {{/if}}
                    {{/if}}
                </div>
            {{/if}}
        {{/if}}
        <GuidNode::Binderhub::-Components::BuildConsole
            @binderHubConfig={{this.binderHubConfig}}
            @currentBinderHubURL={{this.currentBinderHubURL}}
            @renewToken={{action this.renewBinderHubToken}}
            @requestBuild={{action this.requestBuild}}
            @beforeLaunch={{this.performDockerfileSave}}
            @buildLog={{this.buildLog}}
            @buildPhase={{this.buildPhase}}
          />
    {{/if}}
</div>

<BsModal
    data-test-reset-dirty-fragile-files-confirm-modal
    @open={{this.showDirtyFragileFileConfirmDialog}}
    @onHidden={{action (mut this.showDirtyFragileFileConfirmDialog) false}}
    as |modal|
>
    <modal.header>
        <h4>
            {{t 'binderhub.deployment.reset_configfile_confirm_dialog_title'}}
            {{this.dirtyFragileConfigurationFilenames}}
        </h4>
    </modal.header>
    <modal.body>
        {{t 'binderhub.deployment.reset_configfile_confirm_dialog_body'}}
    </modal.body>
    <modal.footer>
        <BsButton
            @onClick={{action (mut this.showDirtyFragileFileConfirmDialog) false}}
        >
            {{t 'general.cancel'}}
        </BsButton>
        <BsButton
            @onClick={{action this.resetDirtyFragileFiles}}
            @type='danger'
        >
            {{t 'general.ok'}}
        </BsButton>
    </modal.footer>
</BsModal>

<BsModal
    @open={{this.pendingImageUrl}}
    @onHidden={{action (mut this.pendingImageUrl) undefined}}
    as |modal|
>
    <modal.header>
        <h4>
            {{t 'binderhub.deployment.destruct_dockerfile_confirmation_dialogue_title'}}
        </h4>
    </modal.header>
    <modal.body>
        {{t
        'binderhub.deployment.destruct_dockerfile_confirmation_dialogue_body'}}
    </modal.body>
    <modal.footer>
        <BsButton
            @onClick={{action (mut this.pendingImageUrl) undefined}}
        >
            {{t 'general.cancel'}}
        </BsButton>
        <BsButton
            @onClick={{action this.selectPendingImage}}
            @type='danger'
        >
            {{t 'general.ok'}}
        </BsButton>
    </modal.footer>
</BsModal>
